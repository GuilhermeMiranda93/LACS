var payment_methods = {
  "BOLETO":{"name":"BOLETO","options":{"BOLETO":{"name":"BOLETO","displayName":"Boleto","status":"AVAILABLE","code":202,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/booklet.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/booklet.png"}}}},"code":2},"BALANCE":{"name":"BALANCE","options":{"BALANCE":{"name":"BALANCE","displayName":"Saldo PagSeguro","status":"AVAILABLE","code":401,"images":null}},"code":4},"ONLINE_DEBIT":{"name":"ONLINE_DEBIT","options":{"BANCO_BRASIL":{"name":"BANCO_BRASIL","displayName":"Banco do Brasil","status":"AVAILABLE","code":304,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/bb.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/bb.png"}}},"BANRISUL":{"name":"BANRISUL","displayName":"Banco Banrisul","status":"AVAILABLE","code":306,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/banrisul.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/banrisul.png"}}},"BRADESCO":{"name":"BRADESCO","displayName":"Banco Bradesco","status":"AVAILABLE","code":301,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/bradesco.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/bradesco.png"}}},"ITAU":{"name":"ITAU","displayName":"Banco Itaú","status":"AVAILABLE","code":302,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/itau.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/itau.png"}}}},"code":3},"CREDIT_CARD":{"name":"CREDIT_CARD","options":{"AMEX":{"name":"AMEX","displayName":"American Express","status":"AVAILABLE","code":103,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/amex.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/amex.png"}}},"AURA":{"name":"AURA","displayName":"Aura","status":"AVAILABLE","code":106,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/aura.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/aura.png"}}},"BRASILCARD":{"name":"BRASILCARD","displayName":"BrasilCard","status":"AVAILABLE","code":112,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/brasilcard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/brasilcard.png"}}},"CABAL":{"name":"CABAL","displayName":"Cabal","status":"AVAILABLE","code":116,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/cabal.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/cabal.png"}}},"CARDBAN":{"name":"CARDBAN","displayName":"CARDBAN","status":"UNAVAILABLE","code":114,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/cardban.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/cardban.png"}}},"DINERS":{"name":"DINERS","displayName":"Diners","status":"AVAILABLE","code":104,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/diners.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/diners.png"}}},"ELO":{"name":"ELO","displayName":"Elo","status":"AVAILABLE","code":107,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/elo.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/elo.png"}}},"FORTBRASIL":{"name":"FORTBRASIL","displayName":"FORTBRASIL","status":"AVAILABLE","code":113,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/fortbrasil.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/fortbrasil.png"}}},"GRANDCARD":{"name":"GRANDCARD","displayName":"GRANDCARD","status":"AVAILABLE","code":119,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/grandcard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/grandcard.png"}}},"HIPERCARD":{"name":"HIPERCARD","displayName":"Hipercard","status":"AVAILABLE","code":105,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/hipercard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/hipercard.png"}}},"MAIS":{"name":"MAIS","displayName":"Mais!","status":"AVAILABLE","code":117,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/mais.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/mais.png"}}},"MASTERCARD":{"name":"MASTERCARD","displayName":"MasterCard","status":"AVAILABLE","code":102,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/mastercard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/mastercard.png"}}},"PERSONALCARD":{"name":"PERSONALCARD","displayName":"PersonalCard","status":"AVAILABLE","code":109,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/personalcard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/personalcard.png"}}},"PLENOCARD":{"name":"PLENOCARD","displayName":"PLENOCard","status":"UNAVAILABLE","code":108,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/plenocard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/plenocard.png"}}},"SOROCRED":{"name":"SOROCRED","displayName":"Sorocred","status":"AVAILABLE","code":120,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/sorocred.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/sorocred.png"}}},"VALECARD":{"name":"VALECARD","displayName":"VALECARD","status":"AVAILABLE","code":115,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/valecard.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/valecard.png"}}},"VISA":{"name":"VISA","displayName":"Visa","status":"AVAILABLE","code":101,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/visa.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/visa.png"}}}},"code":1},"DEPOSIT":{"name":"DEPOSIT","options":{"BANCO_BRASIL":{"name":"BANCO_BRASIL","displayName":"Banco do Brasil","status":"AVAILABLE","code":701,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/bb.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/bb.png"}}},"HSBC":{"name":"HSBC","displayName":"HSBC","status":"UNAVAILABLE","code":702,"images":{"SMALL":{"size":"SMALL","path":"/public/img/payment-methods-flags/42x20/hsbc.png"},"MEDIUM":{"size":"MEDIUM","path":"/public/img/payment-methods-flags/68x30/hsbc.png"}}}},"code":7}
};

var brand = '';
var valid_card = false;
$(document).ready(function() {

  $('.loader').show();

  abrirSessao();

  $('#telefone').mask('(00) 0000-0000');
  $('#cpf').mask('000.000.000-00', {reverse: true});
  $('.cpf').mask('000.000.000-00', {reverse: true});
  var maskBehavior = function (val) {
    return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
  },
  options = {onKeyPress: function(val, e, field, options) {
    field.mask(maskBehavior.apply({}, arguments), options);
  }};

  $('#celular').mask(maskBehavior, options);
  $('.telefone').mask(maskBehavior, options);
  $('#form-cartao-numero').mask('0000 0000 0000 0000');
  $('#form-cartao-data-venc').mask('00/0000');
  $('.nascimento').mask('00/00/0000');

  function limpa_formulário_cep() {

    $("#rua").val("");
    $("#bairro").val("");
    $("#cidade").val("");
    $("#uf").val("");
    $("#ibge").val("");
  }

  $("#cep").blur(function() {


    var cep = $(this).val().replace(/\D/g, '');


    if (cep != "") {


      var validacep = /^[0-9]{8}$/;


      if(validacep.test(cep)) {


        $("#rua").val("...");
        $("#bairro").val("...");
        $("#cidade").val("...");
        $("#uf").val("...");
        $("#ibge").val("...");


        $.getJSON("https://viacep.com.br/ws/"+ cep +"/json/?callback=?", function(dados) {

          if (!("erro" in dados)) {

            $("#rua").val(dados.logradouro);
            $("#bairro").val(dados.bairro);
            $("#cidade").val(dados.localidade);
            $("#uf").val(dados.uf);
            $("#ibge").val(dados.ibge);
          }
          else {

            limpa_formulário_cep();
            alert("CEP não encontrado.");
          }
        });
      }
      else {

        limpa_formulário_cep();
        alert("Formato de CEP inválido.");
      }
    }
    else {

      limpa_formulário_cep();
    }
  });
});

$('#plano_cartao').change(function(){
  console.log('mudando');
  if(brand != ''){
    qtdParcelas(brand)
  }
  // else if ($('#forma_pgto').val() == 4) {
  //   var options = '';
  //
  //   $('.loader').show();
  //   $.ajax({
  //     url:'/dados_plano',
  //     method:'POST',
  //     type:'json',
  //     data:{id:$('#plano_cartao').val()},
  //     success:function(result){
  //       $('.loader').hide();
  //       var valor_plano = result.plano.preco;
  //       for (var i = 1; i <= 12; i++) {
  //         var valor_plano_final = valor_plano/i;
  //         options += '<option value="'+i+'">'+i+'x de R$ '+valor_plano_final.toFixed(2).replace('.',',')+'</option>'
  //       }
  //
  //       $('#parcelas select').empty();
  //       $('#parcelas select').append(options);
  //     }
  //   })
  //
  //
  // }
  else{
    var options = '';

    $('.loader').show();
    $.ajax({
      url:'/dados_plano',
      method:'POST',
      type:'json',
      data:{id:$('#plano_cartao').val()},
      success:function(result){
        $('.loader').hide();
        var valor_plano = result.plano.preco;
        for (var i = 1; i <= 12; i++) {
          var valor_plano_final = valor_plano/i;
          options += '<option value="'+i+'">'+i+'x de R$ '+valor_plano_final.toFixed(2).replace('.',',')+'</option>'
        }

        $('#parcelas select').empty();
        $('#parcelas select').append(options);
      }
    })
  }
})

$('#form-cartao-numero').keypress(function(){

  let credit_card = $(this).cleanVal();
  if(credit_card.length == 6){
    PagSeguroDirectPayment.getBrand({
        cardBin: credit_card,
        success: function(response) {
          brand = response.brand.name;
          var cartoes = payment_methods.CREDIT_CARD.options;
          $('#card-brand').attr('src','https://stc.pagseguro.uol.com.br'+cartoes[response.brand.name.toUpperCase()].images.MEDIUM.path);
          if(credit_card.length == 6 && $('#forma_pgto').val() == 3){
            qtdParcelas(response.brand.name.toLowerCase());
          }
          brand_card = response.brand.name.toLowerCase();
        },
        error: function(response) {
          console.log(response);
        }
    });
  }

  $(this).validateCreditCard(function(result) {

    if(result.valid){
      $('#valid_card').show();
      $('#invalid_card').hide();
      valid_card = true;
    }
    else{
      $('#invalid_card').show();
      $('#valid_card').hide();
      valid_card = false;
    }
  });
})

function qtdParcelas(cartao){

  $('.loader').show();
  $.ajax({
    url:'/dados_plano',
    method:'POST',
    type:'json',
    data:{id:$('#plano_cartao').val()},
    success:function(result){
      var amount = result.plano.preco;
      PagSeguroDirectPayment.getInstallments({
        amount: parseFloat(amount).toFixed(2),
        maxInstallmentNoInterest: 4,
        brand: cartao,
        success: function(response){
        $('.loader').hide();
         var parcelas = '';
         for (var i = 0; i < response.installments[cartao].length; i++) {
           parcelas += '<option data-parcelas="'+response.installments[cartao][i].installmentAmount+'" value="'+response.installments[cartao][i].quantity+'">'+response.installments[cartao][i].quantity+'X de R$ '+response.installments[cartao][i].installmentAmount.toFixed(2).replace('.',',')+' ('+(response.installments[cartao][i].interestFree ? 'Sem Juros' : 'Com Juros')+')'+'</option>';
         }
         $('#parcelas select').empty();
         $('#parcelas select').append(parcelas);
       },
        error: function(response) {
       	 console.log('error ',response)
       }
      });
    }
  })


}

$('#forma_pgto').change(function(){

  if($(this).val() == 2){
    $('#parcelas-boleto select').val('');
    $('#parcelas-boleto').show();
  }
  else{
    $('#parcelas-boleto select').val('');
    $('#parcelas-boleto').hide();
  }

  if($(this).val() == 3){
    $('#parcelas select').val('');
    $('#parcelas').show();
  }
  else{
    $('#parcelas select').val('');
    $('#parcelas').hide();
  }

  if($(this).val() == 3 || $(this).val() == 4){
    $('#cartao-credito').show();
    $('#cartao-credito input').map(function(index, item){
      $(item).attr('required',true)
    });
    $('#parcelas').show();
  }
  else{
    $('#cartao-credito').hide();
    $('#cartao-credito input').map(function(index, item){
      $(item).removeAttr('required')
    });
    $('#parcelas').hide();
  }

  if($(this).val() == 4){
    $('#recorrente-descricao').show();
  }
  else{
    $('#recorrente-descricao').hide();
  }


  if($(this).val() == 4 && $('#plano_cartao').val() != 0){
    var options = '';
    $('.loader').show();
    $.ajax({
      url:'/dados_plano',
      method:'POST',
      type:'json',
      data:{id:$('#plano_cartao').val()},
      success:function(result){
        $('.loader').hide();
        var valor_plano = result.plano.preco;

        for (var i = 1; i <= 12; i++) {
          var valor_plano_final = valor_plano/i;
          options += '<option value="'+i+'">'+i+'x de R$ '+valor_plano_final.toFixed(2).replace('.',',')+'</option>'
        }

        $('#parcelas select').empty();
        $('#parcelas select').append(options);
      }
    })


  }
})

function abrirSessao(){
  $.ajaxSetup({
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
  });

  $.ajax({
    url:'/getSessao',
    type:'POST',
    datatype:'JSON',
    success:function(result){
      let session = JSON.parse(result.retorno);
      PagSeguroDirectPayment.setSessionId(session.id);
      console.log(session.id);
      $('.loader').hide();
    }
  })
}

$('#conferir-pedido').click(function(e){
  e.preventDefault();

  var counter = 0;
  var html = '<ul>';

  $('#form-cartao input[required]').map(function(index,item){
    if($(item).val() == '' || $(item).val() == false){
      html += '<li>Preencha o campo: '+$(item).attr('title')+'</li>';
      counter++;
    }
  })

  $('#form-cartao select[required]').map(function(index,item){
    if($(item).val() == '' || $(item).val() == false){
      html += '<li>Preencha o campo: '+$(item).attr('title')+'</li>';
      counter++;
    }
  })

  if(!$('#form-cartao input[type="checkbox"]').is(':checked')){
    counter++;
    html += '<li>Marque o aceite caso você tenha lido e aceito os termos.</li>';
  }

  if(valid_card == false && ($('#forma_pgto').val() == 3 || $('#forma_pgto').val() == 4)){
    counter++;
    html += '<li>O número do cartão está incorreto.</li>';
  }

  if(new Date($('#datanasc').val()) != 'Invalid Date'){
    let data_nascimento = new Date($('#datanasc').val());
    let atual = new Date();
    let diffTime = Math.abs(data_nascimento - atual);
    let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))
    if(diffDays < 6570){
      counter++;
      html += '<li>Você deve ter no mínimo 18 anos.</li>';
    }
  }
  else{
    counter++;
    html += '<li>A data de nascimento está incorreta.</li>';
  }

  if($('#rg').val().length < 7){
    counter++;
    html += '<li>O RG está incorreto.</li>';
  }

  if($('#form-cartao-data-venc').val().length != 7 && ($('#forma_pgto').val() == 3 || $('#forma_pgto').val() == 4)){
    counter++;
    html += '<li>A data de vencimento está incorreta.</li>';
  }

  if(counter == 0){
    $('.loader').show();
    $.ajax({
      url:'/dados_plano',
      method:'POST',
      type:'json',
      data:{id:$('#plano_cartao').val()},
      success:function(result){
        $('.loader').hide();

        $('#modal-confirmacao').find('.modal-body').empty();
        $('#modal-confirmacao').modal('show');

        var html = '<div class="row"><div class="col-md-6">';
        html += '<h4 class="mt-5">Dados da Compra</h4>';
        html += '<p>Plano: '+$('#plano_cartao').find(':selected').text()+'</p>';
        html += '<p>Valor Total: R$ '+parseFloat(result.plano.preco).toFixed(2).replace('.',',')+'</p>';
        if($('#forma_pgto').val() == 2){
          html += '<p>Valor das Parcelas: '+$('#parcelas-boleto select').val()+'X de R$ '+(parseFloat(result.plano.preco)/$('#parcelas-boleto select').val()).toFixed(2).replace('.',',')+'</p>';
        }
        else if ($('#forma_pgto').val() == 3 || $('#forma_pgto').val() == 4) {
          html += '<p>Valor das Parcelas: '+$('#parcelas select').find(':selected').text()+'</p>';
        }

        html += '<p>Forma de Pagamento: '+$('#forma_pgto').find(':selected').text()+'</p>';

        if($('#forma_pgto').val() == 3 || $('#forma_pgto').val() == 4){
          html += '<p>Num. Cartão: '+$('#form-cartao-numero').val()+'</p>';
          html += '<p>Vencto: '+$('#form-cartao-data-venc').val()+'</p>';
          html += '<p>CVV: '+$('#form-cartao-digito').val()+'</p>';
          html += '<p>Nome Impresso: '+$('#form-cartao-nome').val()+'</p>';
          html += '<p>CPF Titular: '+$('#form-cartao-cpf').val()+'</p>';
          html += '<p>Fone Titular: '+$('#form-cartao-telefone').val()+'</p>';
          html += '<p>D. Nasc. Titular: '+$('#form-cartao-nascimento').val()+'</p>';
        }

        html += '</div><div class="col-md-6">';
        html += '<h4 class="mt-5">Dados Pessoais</h4>';
        html += '<p>Nome: '+$('input[name="nome"]').val()+' '+$('input[name="sobrenome"]').val()+'</p>';
        html += '<p>Email: '+$('input[name="email"]').val()+'</p>';
        html += '<p>Telefone: '+$('input[name="telefone"]').val()+'</p>';
        html += '<p>Data de Nascimento: '+$('input[name="datanasc"]').val()+'</p>';
        html += '<p>CPF: '+$('input[name="cpf"]').val()+'</p>';
        html += '<p>RG: '+$('input[name="rg"]').val()+'</p>';
        html += '<p>Celular: '+$('input[name="celular"]').val()+'</p>';
        html += '<p>Endereço: '+$('input[name="rua"]').val()+', '+$('input[name="numero"]').val()+' '+$('input[name="complemento"]').val()+' - '+$('input[name="bairro"]').val()+' - '+$('input[name="cidade"]').val()+'/'+$('#uf').val()+' - '+$('input[name="cep"]').val()+'</p>';
        html += '</div></div>';

        $('#modal-confirmacao').find('.modal-body').append(html);


      }
    })

  }
  else{

    html += '</ul>';
    Swal.fire({
      type:'error',
      title:'Oops...',
      html:html
    })
  }


})

function confirmarCompra(){

  $('.loader').show();

  if($('#forma_pgto').val() == 3 || $('#forma_pgto').val() == 4){
    PagSeguroDirectPayment.createCardToken({
       cardNumber: $('#form-cartao-numero').val(), // Número do cartão de crédito
       brand: brand, // Bandeira do cartão
       cvv: $('#form-cartao-digito').val(), // CVV do cartão
       expirationMonth: $('#form-cartao-data-venc').val().substring(0,2), // Mês da expiração do cartão
       expirationYear: $('#form-cartao-data-venc').val().substring(3,$('#form-cartao-data-venc').val().length), // Ano da expiração do cartão, é necessário os 4 dígitos.
       success: function(response) {
        var card_token = response.card.token;
        PagSeguroDirectPayment.onSenderHashReady(function(response){
          if(response.status == 'error') {
            return false;
          }
          hash = response.senderHash; //Hash estará disponível nesta variável.
          enviarFormulario(hash, card_token)
        });
       },
       error: function(response) {
         $('.loader').hide();
         Swal.fire({
           type:'error',
           title:'O cartão de crédito está inválido.'
         })
       }
     });
  }
  else{
    PagSeguroDirectPayment.onSenderHashReady(function(response){
      if(response.status == 'error') {
        $('.loader').hide();
        Swal.fire({
          type:'error',
          title:'O cartão de crédito está inválido.'
        })
        return false;
      }
      hash = response.senderHash; //Hash estará disponível nesta variável.
      enviarFormulario(hash, null)
    });
  }


}

function enviarFormulario(hash, card_token){

  let tipo = '';
  switch ($('#forma_pgto').val()) {
    case '1':
      tipo = 'boleto'
    break;
    case '2':
      tipo = 'boleto'
    break;
    case '3':
      tipo = 'creditCard'
    break;
    case '4':
      tipo = 'creditCard'
    break;
  }

  let plan = '';

  switch ($('#plano_cartao').val()) {
    case '2':
      //plan = 'A9308D8AC7C72FACC4160F8B4AC61CC1'
      plan = '76FCFD98E4E4CDA224E54FB7622C6B2F'
    break;
    case '3':
      //plan = 'DF9CA04134343912242B8F80A3CB50CD'
      plan = 'F65B984DB6B6360BB46AEF92BFB81FC7'
    break;
    case '4':
      plan = 'D78E84697F7FE55EE40ADFB792DAAE89'
    break;
    case '5':
      plan = '9C750A197474C41AA4538FA47F09D751'
    break;
  }

  if($('#forma_pgto').val() == 2){
    $('#form-cartao').submit();
  }
  else if ($('#forma_pgto').val() == 4) {


    // let valor = parseFloat(result.plano.preco/$('#parcelas select').val());
    // let valor = parseFloat($('#parcelas select').find(':selected').attr('data-preco'));

    $.ajax({
      url:'/criar_plano',
      method:'POST',
      data:{
        id_cartao:$('#plano_cartao').val(),
        plano:$('#plano_cartao').find(':selected').text(),
        // valor:valor.toFixed(2),
        parcelas:parseFloat($('#parcelas select').val())
      },
      success:function(retorno){
        if(retorno.retorno.code){
          $.ajax({
            url:'/pagamento_recorrente_pagseguro',
            method:'POST',
            data:{
              plan: retorno.retorno.code,
            	reference: $('#plano_cartao').find(':selected').text(),
            	sender: {
            		name: $('input[name="nome"]').val()+' '+$('input[name="sobrenome"]').val(),
            		email: $('input[name="email"]').val(),
            		hash: hash,
            		phone: {
            			areaCode: $('input[name="celular"]').cleanVal().substring(0,2),
            			number: $('input[name="celular"]').cleanVal().substring(2,$('input[name="celular"]').cleanVal().length)
            		},
            		address: {
            			street: $('input[name="rua"]').val(),
            			number: $('input[name="numero"]').val(),
            			complement: $('input[name="complemento"]').val(),
            			district: $('input[name="bairro"]').val(),
            			city: $('input[name="cidade"]').val(),
            			state: $('#uf').val(),
            			country: "BRA",
            			postalCode: $('input[name="cep"]').val()
            		},
            		documents: [{
            			type: "CPF",
            			value: $('input[name="cpf"]').cleanVal()
            		}]
            	},
            	paymentMethod: {
            		type: "CREDITCARD",
            		creditCard: {
            			token: card_token,
            			holder: {
            				name: $('#form-cartao-nome').val(),
            				birthDate: $('#form-cartao-nascimento').val(),
            				documents: [{
            					type: "CPF",
            					value: $('#form-cartao-cpf').cleanVal()
            				}],
            				phone: {
            					areaCode: $('#form-cartao-telefone').cleanVal().substring(0,2),
            					number: $('#form-cartao-telefone').cleanVal().substring(2,$('input[name="celular"]').cleanVal().length)
            				},
            				billingAddress: {
                      street: $('input[name="rua"]').val(),
                			number: $('input[name="numero"]').val(),
                			complement: $('input[name="complemento"]').val(),
                			district: $('input[name="bairro"]').val(),
                			city: $('input[name="cidade"]').val(),
                			state: $('#uf').val(),
                			country: "BRA",
                			postalCode: $('input[name="cep"]').val()
            				}
            			}
            		}
            	},
              /*Dados extras para salvar no banco*/
              nome:$('input[name="nome"]').val(),
              sobrenome:$('input[name="sobrenome"]').val(),
              datanasc:$('input[name="datanasc"]').val(),
              rg:$('input[name="rg"]').val(),
              telefone:$('input[name="telefone"]').val(),
              celular:$('input[name="celular"]').val(),
              forma_pgto:$('#forma_pgto').val(),
              parcelas:$('select[name="parcelas"]').val(),
              comprovante:$('input[name="comprovante"]').prop('files')[0],
              id_plano:$('#plano_cartao').val(),
              valor_plano:retorno.valor.toFixed(2)
            },
            success:function(result){

              $('.loader').hide();
              if(JSON.parse(result.retorno).error){

                let html_pagseguro = '<ul>';

                Object.keys(JSON.parse(result.retorno).errors).map(function(key) {

                  switch (key) {
                    case '19001':
                      html_pagseguro += '<li>'+key+' - CEP inválido.</li>'
                      break;
                    case '19002':
                      html_pagseguro += '<li>'+key+' - Logradouro inválido.</li>'
                      break;
                    case '19003':
                      html_pagseguro += '<li>'+key+' - Número do endereço inválido.</li>'
                      break;
                    case '19004':
                      html_pagseguro += '<li>'+key+' - Complemento inválido.</li>'
                      break;
                    case '19005':
                      html_pagseguro += '<li>'+key+' - Bairro inválido.</li>'
                      break;
                    case '19006':
                      html_pagseguro += '<li>'+key+' - Cidade inválida.</li>'
                      break;
                    case '19007':
                      html_pagseguro += '<li>'+key+' - UF inválido.</li>'
                      break;
                    case '11013':
                      html_pagseguro += '<li>'+key+' - Código de área do telefone inválido.</li>'
                      break;
                    case '11014':
                      html_pagseguro += '<li>'+key+' - Telefone inválido.</li>'
                      break;
                    case '53048':
                      html_pagseguro += '<li>'+key+' - Data de nascimento inválida do titular do cartão.</li>'
                      break;
                    case '61011':
                      html_pagseguro += '<li>'+key+' - CPF inválido.</li>'
                      break;
                    case '10003':
                      html_pagseguro += '<li>'+key+' - Email inválido.</li>'
                      break;
                    default:
                      html_pagseguro += '<li>'+key+' - Erro desconhecido</li>';
                      break;

                  }
                });

                html_pagseguro += '</ul>'

                Swal.fire({
                  type:'error',
                  title:'Algo deu errado...',
                  html:html_pagseguro
                })
              }
              else{
                $('.pre-compra').hide();
                $('.pos-compra').show();
                Swal.fire({
                  type:'success',
                  title:'Obrigado pela compra!',
                  text:'Um de nossos colaboradores irá entrar em contato com você.'
                }).then(function(result){
                    location.reload();

                })

              }
            },
            error:function(error){
              $('.loader').hide();
              console.log('deu errrrrro');
              console.log(error);
            }
          })
        }
        else{
          $('.loader').hide();
          Swal.fire({
            type:'error',
            title:'Algo deu errado...',
            text:'Código do erro: '+retorno
          })
        }

      }
    })

  }
  else{

    $.ajax({
      url:'/dados_plano',
      method:'POST',
      type:'json',
      data:{id:$('#plano_cartao').val()},
      success:function(result){
        let valor = parseFloat(result.plano.preco);

        $.ajax({
          url:'/pagamento_pagseguro',
          method:'POST',
          data:{
            /*Tipo do pagamento*/
            paymentMode:'default',
            paymentMethod:tipo, //'creditCard'
            currency:'BRL',
            /*Produto*/
            itemId1:$('#plano_cartao').val(),
            itemDescription1:$('#plano_cartao').find(':selected').text(),
            itemAmount1:valor.toFixed(2),
            itemQuantity1:'1',
            /*Informaçoes do sistema*/
            reference:$('#plano_cartao').find(':selected').text(),
            /*Dados do comprador*/
            senderName:$('input[name="nome"]').val()+' '+$('input[name="sobrenome"]').val(),
            senderCPF:$('input[name="cpf"]').cleanVal(),
            senderAreaCode:$('input[name="celular"]').cleanVal().substring(0,2),
            senderPhone:$('input[name="celular"]').cleanVal().substring(2,$('input[name="celular"]').cleanVal().length),
            senderEmail:$('input[name="email"]').val(),
            senderHash:hash,
            /*Dados de entrega*/
            shippingAddressRequired: false, // Não precisa colocar os dados de entrega
            creditCardToken:card_token,
            installmentQuantity:$('#parcelas select').val(),
            installmentValue:parseFloat($('#parcelas select').find(':selected').attr('data-parcelas')).toFixed(2),
            noInterestInstallmentQuantity:'4',
            creditCardHolderName:$('#form-cartao-nome').val(),
            creditCardHolderCPF:$('#form-cartao-cpf').cleanVal(),
            creditCardHolderBirthDate:$('#form-cartao-nascimento').val(),
            creditCardHolderAreaCode:$('#form-cartao-telefone').cleanVal().substring(0,2),
            creditCardHolderPhone:$('#form-cartao-telefone').cleanVal().substring(2,$('input[name="celular"]').cleanVal().length),
            /*Endereço de cobrança*/
            billingAddressStreet:$('input[name="rua"]').val(),
            billingAddressNumber:$('input[name="numero"]').val(),
            billingAddressComplement:$('input[name="complemento"]').val(),
            billingAddressDistrict:$('input[name="bairro"]').val(),
            billingAddressPostalCode:$('input[name="cep"]').val(),
            billingAddressCity:$('input[name="cidade"]').val(),
            billingAddressState:$('#uf').val(),
            billingAddressCountry:'BRA',
            /*Dados extras para salvar no banco*/
            nome:$('input[name="nome"]').val(),
            sobrenome:$('input[name="sobrenome"]').val(),
            datanasc:$('input[name="datanasc"]').val(),
            rg:$('input[name="rg"]').val(),
            telefone:$('input[name="telefone"]').val(),
            celular:$('input[name="celular"]').val(),
            forma_pgto:$('#forma_pgto').val(),
            parcelas:$('select[name="parcelas"]').val(),
            comprovante:$('input[name="comprovante"]').prop('files')[0]

          },
          success:function(result){

            $('.loader').hide();

            if(JSON.parse(result.retorno).error){

              let html_pagseguro = '<ul>';

              Object.keys(JSON.parse(result.retorno).errors).map(function(key) {

                switch (key) {
                  case '19001':
                    html_pagseguro += '<li>'+key+' - CEP inválido.</li>'
                    break;
                  case '19002':
                    html_pagseguro += '<li>'+key+' - Logradouro inválido.</li>'
                    break;
                  case '19003':
                    html_pagseguro += '<li>'+key+' - Número do endereço inválido.</li>'
                    break;
                  case '19004':
                    html_pagseguro += '<li>'+key+' - Complemento inválido.</li>'
                    break;
                  case '19005':
                    html_pagseguro += '<li>'+key+' - Bairro inválido.</li>'
                    break;
                  case '19006':
                    html_pagseguro += '<li>'+key+' - Cidade inválida.</li>'
                    break;
                  case '19007':
                    html_pagseguro += '<li>'+key+' - UF inválido.</li>'
                    break;
                  case '11013':
                    html_pagseguro += '<li>'+key+' - Código de área do telefone inválido.</li>'
                    break;
                  case '11014':
                    html_pagseguro += '<li>'+key+' - Telefone inválido.</li>'
                    break;
                  case '53048':
                    html_pagseguro += '<li>'+key+' - Data de nascimento inválida do titular do cartão.</li>'
                    break;
                  case '61011':
                    html_pagseguro += '<li>'+key+' - CPF inválido.</li>'
                    break;
                  case '10003':
                    html_pagseguro += '<li>'+key+' - Email inválido.</li>'
                    break;
                  default:
                    html_pagseguro += '<li>'+key+' - Erro desconhecido</li>';
                    break;

                }
              });

              html_pagseguro += '</ul>'

              Swal.fire({
                type:'error',
                title:'Algo deu errado...',
                html:html_pagseguro
              })
            }
            else{
              $('.pre-compra').hide();


              if(result.retorno.paymentMethod.type == 2){
                $('.imprimir-boleto').show();
                $('.imprimir-boleto').attr('href',result.retorno.paymentLink);
                $('.pos-compra').show();
                console.log($('#modal-confirmacao').find('.pos-compra'))
                $('#modal-confirmacao').find('.pos-compra').attr('onClick','location.reload()');
                Swal.fire({
                  type:'success',
                  title:'Obrigado pela compra!',
                  text:'Clique no botão "Imprimir Boleto" e efetue o pagamento.'
                })
              }
              else{
                $('.pos-compra').show();
                Swal.fire({
                  type:'success',
                  title:'Obrigado pela compra!',
                  text:'Um de nossos colaboradores irá entrar em contato com você.'
                }).then(function(result){
                  location.reload();
                })
              }

            }
            // $('#form-cartao').submit()
          }
        })
      }
    });

  }


}
